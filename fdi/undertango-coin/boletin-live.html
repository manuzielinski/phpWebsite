<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Boletín Lunar - 2025 - Undertango Fondo de Inversión</title>

    <!-- Estilos Básicos -->
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 0;
        font-size: 16px;
      }
      .container {
        width: 95%;
        max-width: 1080px;
        margin: auto;
        overflow: hidden;
        padding: 5px;
      }
      header {
        background: #333;
        color: #fff;
        padding: 15px 0;
        border-bottom: #77aaff 3px solid;
        text-align: center;
        position: relative;
      }
      header h1 {
        margin: 0;
        font-size: 1.7em;
        text-transform: uppercase;
      }
      .logo-luna {
        width: 60px;
        position: absolute;
        top: 10px;
        left: 10px;
      }
      .main {
        background: #fff;
        margin: 10px 0;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }
      .info-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 10px;
        background: #e2e2e2;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .info-box > div {
        flex: 1 1 300px;
        text-align: center;
        margin: 5px;
      }
      .info-box h2 {
        margin: 5px 0;
        font-size: 1.2em;
      }
      .large-text {
        font-size: 1.4em;
        font-weight: bold;
      }
      .variation {
        font-weight: bold;
      }
      .green-text {
        color: #28a745;
      }
      .red-text {
        color: #dc3545;
      }
      .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
      }
      .grid-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 10px;
        background: #e2e2e2;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .grid-box > div {
        flex: 1 1 300px;
        margin: 5px;
      }
      .bold-text {
        font-weight: bold;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
      }
      table th,
      table td {
        padding: 8px;
        border-bottom: 1px solid #ccc;
        text-align: left;
      }
      .distribution-section {
        background: #fff;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .distribution-section h2 {
        margin-top: 0;
      }
      .distribution-box {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 10px;
      }
      .distribution-client {
        flex: 1 1 250px;
        background: #eaeaea;
        padding: 10px;
        border-radius: 5px;
      }
      .distribution-client h3 {
        margin-top: 0;
        font-size: 1.1em;
        text-align: center;
      }
      .distribution-client ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .distribution-client ul li {
        margin: 4px 0;
      }
      .movimientos-section {
        background: #fff;
        margin-top: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 15px;
      }
      .movimientos-section h2 {
        margin-top: 0;
      }
      .registro-form {
        margin-top: 20px;
        padding: 15px;
        background: #fdfdfd;
        border-radius: 5px;
      }
      .registro-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .registro-form input,
      .registro-form select,
      .registro-form button {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      .registro-form button {
        background: #333;
        color: #fff;
        cursor: pointer;
      }
      .registro-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .registro-table th,
      .registro-table td {
        padding: 8px;
        border-bottom: 1px solid #ccc;
      }
      .registro-table th {
        background: #f4f4f4;
      }
      @media (max-width: 600px) {
        .info-box,
        .grid-box,
        .distribution-box {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>

    <!-- Librería de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body>
    <header>
      <img
        class="logo-luna"
        src="https://cdn-icons-png.flaticon.com/512/3267/3267734.png"
        alt="Logo Luna"
        class="logo-luna"
      />
      <h1>Boletín Luna N°1 - 2025 Undertango Fondo de Inversión</h1>
    </header>

    <div class="container">
      <!-- Sección Principal -->
      <div class="main">
        <!-- Caja Undertango y Fondo de Inversión -->
        <div class="info-box" id="infoBoxGeneral">
          <div>
            <h2>Caja Undertango (AR$)</h2>
            <p class="large-text" id="valorCajaUndertango">Cargando...</p>
          </div>
          <div>
            <h2>Fondo de Inversión (AR$)</h2>
            <p class="large-text" id="valorFondoInversion">Cargando...</p>
            <p>(Monto total a retribuir)</p>
          </div>
        </div>

        <!-- Valor de la Acción y Retribución Mensual -->
        <div class="info-box">
          <div>
            <h2>Valor de la Acción</h2>
            <p class="large-text" id="valorAccion">Cargando...</p>
          </div>
          <div>
            <h2>Retribución Mensual por Acción</h2>
            <p class="large-text" id="retribucionPorAccion">Cargando...</p>
          </div>
        </div>

        <!-- Gráfico de Evolución -->
        <div class="chart-container">
          <canvas id="chartEvolucion"></canvas>
        </div>

        <!-- Datos de Accionistas y Variación -->
        <div class="grid-box">
          <div>
            <h3>Accionistas</h3>
            <table id="tablaAccionistas">
              <thead>
                <tr>
                  <th>Inversor</th>
                  <th>Acciones</th>
                  <th>Capital (AR$)</th>
                  <th>Porcentaje</th>
                  <th>Retribución</th>
                </tr>
              </thead>
              <tbody id="listaAccionistas"></tbody>
            </table>
            <p class="bold-text" style="text-align: right; margin-top: 5px;">
              Total Acciones: <span id="accionesTotales">...</span>
            </p>
          </div>
          <div>
            <h3>Variación en los Últimos Registros</h3>
            <p class="variation" id="variacionCajaUndertango"></p>
          </div>
        </div>
      </div>

      <!-- Distribución por Cliente -->
      <div class="distribution-section">
        <h2>Distribución por Cliente</h2>
        <p>
          Estos son los porcentajes actuales definidos en el Fondo de Inversión,
          agrupados por la columna "Distribución":
        </p>
        <div class="distribution-box" id="distributionBox">
          <!-- Se llenará dinámicamente -->
        </div>
      </div>

      <!-- Movimientos (FDI-Movimientos) -->
      <div class="movimientos-section">
        <h2>Registro de Movimientos (Fondo de Inversión)</h2>
        <table class="registro-table" id="tablaMovimientos">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Inversor</th>
              <th>Acción</th>
              <th>Cantidad</th>
            </tr>
          </thead>
          <tbody id="listaMovimientos"></tbody>
        </table>

        <!-- Formulario para Agregar Nuevo Movimiento -->
        <div class="registro-form">
          <h3>Agregar Movimiento</h3>
          <label for="fechaMovimiento">Fecha</label>
          <input type="date" id="fechaMovimiento" />

          <label for="inversorMovimiento">Inversor</label>
          <select id="inversorMovimiento">
            <option value="">--Seleccione--</option>
            <option value="Bianca Wagner">Bianca Wagner</option>
            <option value="Luciano Valdemarín">Luciano Valdemarín</option>
            <option value="Pablo Cieslik">Pablo Cieslik</option>
            <!-- Agrega más inversores si corresponde -->
          </select>

          <label for="accionMovimiento">Acción</label>
          <select id="accionMovimiento">
            <option value="">--Seleccione--</option>
            <option value="Compra Acciones">Compra Acciones</option>
            <option value="Vende Acciones">Vende Acciones</option>
            <option value="Recibe Retribución">Recibe Retribución</option>
          </select>

          <label for="cantidadMovimiento">Cantidad</label>
          <input type="number" id="cantidadMovimiento" step="0.01" />

          <button id="btnAgregarMovimiento">Agregar Movimiento</button>
        </div>
      </div>
    </div>

    <!-- JavaScript Principal -->
    <script>
      /************************************************************
       *                   Configuración de Airtable
       ************************************************************/
      const AIRTABLE_API_KEY =
        "patDkgh9AOk8DJ2gz.b5d34c70d323a35badc12a52130e8b64926e6924f532904fa74a92dbc60f0dbf";
      const BASE_ID = "appi5urGbKh6fh62Z";

      // Nombres de las tablas (pestañas) en Airtable
      const TABLE_CAJAS_COMBINADAS = "Cajas Combinadas";
      const TABLE_CAJAS = "Cajas";
      const TABLE_FDI = "FDI";
      const TABLE_CALENDARIO = "Calendario";
      const TABLE_DISTRIBUCIONES = "Distribuciones";
      const TABLE_MOVIMIENTOS = "FDI-Movimientos";

      /************************************************************
       *                   Variables globales
       ************************************************************/
      let cajaUndertango = 0;
      let fondoInversion = 0;
      let totalAcciones = 0;
      let valorAccion = 0;
      let retribucionMensualPorAccion = 0;

      // Arreglo con el historial de 3 columnas:
      // [{ fecha, montoALaFecha, plazoFijo, activo }, ... ]
      let historicoActivos = [];

      let inversores = [];

      /************************************************************
       *                 Obtención de datos (Fetch)
       ************************************************************/

      /**
       * Obtiene el valor de la Caja Undertango desde "Cajas Combinadas",
       * filtrando por el registro cuyo campo "Name" sea "Cajas combinadas UT-FDI".
       */
      async function obtenerCajaUndertango() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(
            TABLE_CAJAS_COMBINADAS
          )}?filterByFormula={Name}='Cajas combinadas UT-FDI'`;
          const respuesta = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
          });
          if (!respuesta.ok) {
            throw new Error("Error al obtener datos de Cajas Combinadas");
          }
          const datos = await respuesta.json();
          if (datos.records && datos.records.length > 0) {
            cajaUndertango = parseFloat(datos.records[0].fields["Total"]) || 0;
          }
        } catch (error) {
          console.error("obtenerCajaUndertango:", error);
        }
      }

      /**
       * Obtiene el valor del Fondo de Inversión desde "Cajas",
       * filtrando por el registro cuyo campo "Name" sea "Fondo de Inversión".
       */
      async function obtenerFondoInversion() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(
            TABLE_CAJAS
          )}?filterByFormula={Name}='Fondo de Inversión'`;
          const respuesta = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
          });
          if (!respuesta.ok) {
            throw new Error("Error al obtener datos de Cajas (Fondo de Inversión)");
          }
          const datos = await respuesta.json();
          if (datos.records && datos.records.length > 0) {
            fondoInversion =
              parseFloat(datos.records[0].fields["Balance Actual Calculado"]) || 0;
          }
        } catch (error) {
          console.error("obtenerFondoInversion:", error);
        }
      }

      /**
       * Obtiene el total de acciones desde la tabla "FDI",
       * filtrando por la fila cuyo campo "Inversor" sea "Total".
       */
      async function obtenerTotalAcciones() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(
            TABLE_FDI
          )}?filterByFormula={Inversor}='Total'`;
          const respuesta = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
          });
          if (!respuesta.ok) {
            throw new Error("Error al obtener el total de acciones en FDI");
          }
          const datos = await respuesta.json();
          if (datos.records && datos.records.length > 0) {
            totalAcciones =
              parseFloat(datos.records[0].fields["FDI Compilación (de FDI)"]) || 0;
          }
        } catch (error) {
          console.error("obtenerTotalAcciones:", error);
        }
      }

      /**
       * Obtiene la lista de inversores desde la tabla "FDI",
       * excluyendo la fila "Total". Se asume que la columna con la cantidad
       * de acciones se llama "Cantidad de Acciones".
       */
      async function obtenerInversores() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(
            TABLE_FDI
          )}`;
          const respuesta = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
          });
          if (!respuesta.ok) {
            throw new Error("Error al obtener datos de inversores - FDI");
          }
          const datos = await respuesta.json();
          inversores = datos.records
            .filter(
              (registro) =>
                registro.fields["Inversor"] &&
                registro.fields["Cantidad de Acciones"] &&
                registro.fields["Inversor"] !== "Total"
            )
            .map((registro) => ({
              id: registro.id,
              nombre: registro.fields["Inversor"],
              acciones: parseFloat(registro.fields["Cantidad de Acciones"]) || 0,
            }));
        } catch (error) {
          console.error("obtenerInversores:", error);
        }
      }

      /**
       * Obtiene la evolución de los activos desde la tabla "Calendario".
       * Se asume que las columnas son:
       * - "Fecha"
       * - "Monto a la Fecha"
       * - "Plazo Fijo"
       * - "Activo"
       */
      async function obtenerEvolucionActivos() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(
            TABLE_CALENDARIO
          )}?sort[0][field]=Fecha&sort[0][direction]=asc`;
          const respuesta = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
          });
          if (!respuesta.ok) {
            throw new Error("Error al obtener datos de Calendario");
          }
          const datos = await respuesta.json();
          historicoActivos = datos.records
            .filter((registro) => registro.fields["Fecha"])
            .map((registro) => ({
              fecha: new Date(registro.fields["Fecha"]),
              montoALaFecha: parseFloat(registro.fields["Monto a la Fecha"]) || 0,
              plazoFijo: parseFloat(registro.fields["Plazo Fijo"]) || 0,
              activo: parseFloat(registro.fields["Activo"]) || 0,
            }));
        } catch (error) {
          console.error("obtenerEvolucionActivos:", error);
        }
      }

      /**
       * Obtiene todos los registros de la tabla "Cajas" y crea un mapa de IDs a nombres.
       */
      async function obtenerCajas() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_CAJAS)}`;
          const respuesta = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
          });
          if (!respuesta.ok) {
            throw new Error("Error al obtener datos de Cajas");
          }
          const datos = await respuesta.json();
          const mapaCajas = {};
          datos.records.forEach((registro) => {
            mapaCajas[registro.id] = registro.fields["Name"] || "(Sin nombre)";
          });
          return mapaCajas;
        } catch (error) {
          console.error("obtenerCajas:", error);
          return {};
        }
      }

      /**
       * Obtiene y renderiza las distribuciones desde la tabla "Distribuciones".
       * Agrupa los registros por el campo "Distribución".
       * - Se omite cualquier grupo llamado "Distr. ø".
       * - Muestra solamente "Caja" y "Porcentaje".
       */
      async function obtenerDistribuciones() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(
            TABLE_DISTRIBUCIONES
          )}`;
          const respuesta = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
          });
          if (!respuesta.ok) {
            throw new Error("Error al obtener datos de Distribuciones");
          }
          const datos = await respuesta.json();
          renderizarDistribuciones(datos.records);
        } catch (error) {
          console.error("obtenerDistribuciones:", error);
        }
      }

      /**
       * Obtiene y renderiza los movimientos desde la tabla "FDI-Movimientos".
       */
      async function obtenerMovimientos() {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(
            TABLE_MOVIMIENTOS
          )}?sort[0][field]=Fecha&sort[0][direction]=desc`;
          const respuesta = await fetch(url, {
            headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
          });
          if (!respuesta.ok) {
            throw new Error("Error al obtener datos de FDI-Movimientos");
          }
          const datos = await respuesta.json();
          renderizarMovimientos(datos.records);
        } catch (error) {
          console.error("obtenerMovimientos:", error);
        }
      }

      /************************************************************
       *                 Lógica de cálculos y renderizado
       ************************************************************/

      /**
       * Calcula la variación porcentual entre el último y el penúltimo registro
       * de "montoALaFecha" para mostrar el porcentaje de cambio.
       */
      function calcularVariacionUltimosRegistros() {
        if (historicoActivos.length < 2) {
          console.warn("No hay suficientes registros para calcular la variación.");
          return 0;
        }

        // Ordenar por fecha para asegurar que los registros estén en orden
        historicoActivos.sort((a, b) => a.fecha - b.fecha);

        const ultimoRegistro = historicoActivos[historicoActivos.length - 1];
        const anteultimoRegistro = historicoActivos[historicoActivos.length - 2];

        const valorUltimo = ultimoRegistro.montoALaFecha;
        const valorAnteultimo = anteultimoRegistro.montoALaFecha;

        // Verificar que los valores sean válidos
        if (isNaN(valorUltimo) || isNaN(valorAnteultimo)) {
          console.warn("Valores inválidos para calcular la variación.");
          return 0;
        }

        // Evitar división por cero
        if (valorAnteultimo === 0) {
          console.warn("El valor anteúltimo es 0, no se puede calcular la variación.");
          return 0;
        }

        // Calcular la variación porcentual
        const variacion = ((valorUltimo - valorAnteultimo) / valorAnteultimo) * 100;
        return variacion;
      }

      /**
       * Calcula el valor de la acción y la retribución mensual por acción
       * en base a cajaUndertango, fondoInversion y totalAcciones.
       */
      function calcularValores() {
        if (totalAcciones > 0) {
          valorAccion = cajaUndertango / totalAcciones;
          retribucionMensualPorAccion = fondoInversion / totalAcciones;
        } else {
          valorAccion = 0;
          retribucionMensualPorAccion = 0;
        }
      }

      /**
       * Renderiza la información principal (Caja, Fondo, Valor de la Acción, etc.)
       * y la tabla de accionistas en el DOM.
       */
      function renderizarDatos() {
        // Caja y Fondo
        document.getElementById("valorCajaUndertango").textContent =
          formatearDinero(cajaUndertango);
        document.getElementById("valorFondoInversion").textContent =
          formatearDinero(fondoInversion);

        // Valor de la Acción y Retribución Mensual
        document.getElementById("valorAccion").textContent =
          formatearDinero(valorAccion);
        document.getElementById("retribucionPorAccion").textContent =
          formatearDinero(retribucionMensualPorAccion);

        // Listado de accionistas
        const cuerpoAccionistas = document.getElementById("listaAccionistas");
        cuerpoAccionistas.innerHTML = "";
        inversores.forEach((inversor) => {
          const capitalInversor = inversor.acciones * valorAccion;
          const porcentajeAcciones = (inversor.acciones / totalAcciones) * 100;
          const retribucionInversor =
            inversor.acciones * retribucionMensualPorAccion;

          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${inversor.nombre}</td>
            <td>${inversor.acciones.toFixed(2)}</td>
            <td>${formatearDinero(capitalInversor)}</td>
            <td>${porcentajeAcciones.toFixed(2)}%</td>
            <td>${formatearDinero(retribucionInversor)}</td>
          `;
          cuerpoAccionistas.appendChild(fila);
        });

        // Total de acciones
        document.getElementById("accionesTotales").textContent =
          totalAcciones.toFixed(2);

        // Variación en los últimos registros
        const variacion = calcularVariacionUltimosRegistros();
        mostrarVariacion(variacion, "variacionCajaUndertango");
      }

      /**
       * Muestra la variación (porcentaje) y el total de la caja en la sección de variación.
       */
      function mostrarVariacion(variacion, elementoId) {
        const spanVariacion = document.getElementById(elementoId);
        const porcentajeTexto = variacion.toFixed(2) + "%";
        const totalCajaTexto = formatearDinero(cajaUndertango);

        if (variacion >= 0) {
          spanVariacion.textContent = `Variación en los últimos registros: +${porcentajeTexto} — Total de Caja Undertango a la fecha: ${totalCajaTexto}`;
          spanVariacion.classList.remove("red-text");
          spanVariacion.classList.add("green-text");
        } else {
          spanVariacion.textContent = `Variación en los últimos registros: ${porcentajeTexto} — Total de Caja Undertango a la fecha: ${totalCajaTexto}`;
          spanVariacion.classList.remove("green-text");
          spanVariacion.classList.add("red-text");
        }
      }

      /**
       * Renderiza el gráfico de evolución (Calendario) usando Chart.js,
       * mostrando "Monto a la Fecha", "Plazo Fijo" y "Activo".
       */
      function dibujarGrafico() {
        const contexto = document.getElementById("chartEvolucion").getContext("2d");
        // Asegurar que esté ordenado por fecha
        historicoActivos.sort((a, b) => a.fecha - b.fecha);

        const etiquetas = historicoActivos.map((item) =>
          item.fecha.toLocaleDateString("es-AR")
        );
        const datosMonto = historicoActivos.map((item) => item.montoALaFecha);
        const datosPlazoFijo = historicoActivos.map((item) => item.plazoFijo);
        const datosActivo = historicoActivos.map((item) => item.activo);

        new Chart(contexto, {
          type: "line",
          data: {
            labels: etiquetas,
            datasets: [
              {
                label: "Monto a la Fecha",
                data: datosMonto,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 2,
                fill: true,
              },
              {
                label: "Plazo Fijo",
                data: datosPlazoFijo,
                backgroundColor: "rgba(255, 206, 86, 0.2)",
                borderColor: "rgba(255, 206, 86, 1)",
                borderWidth: 2,
                fill: true,
              },
              {
                label: "Activo",
                data: datosActivo,
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: function (valor) {
                    return formatearDinero(valor);
                  },
                },
              },
            },
          },
        });
      }

      /**
       * Renderiza los movimientos en la tabla correspondiente.
       */
      function renderizarMovimientos(registros) {
        const cuerpoTabla = document.getElementById("listaMovimientos");
        cuerpoTabla.innerHTML = "";
        registros.forEach((registro) => {
          const campos = registro.fields;
          const fecha = campos["Fecha"]
            ? new Date(campos["Fecha"]).toLocaleDateString()
            : "";
          const inversor = campos["Inversor"] || "";
          const accion = campos["Acción"] || "";
          const cantidad = campos["Cantidad"] || 0;

          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${fecha}</td>
            <td>${inversor}</td>
            <td>${accion}</td>
            <td>${cantidad}</td>
          `;
          cuerpoTabla.appendChild(fila);
        });
      }

      /**
       * Agrupa los registros de "Distribuciones" por la columna "Distribución".
       * Omite el grupo "Distr. ø". Para cada ítem, muestra el nombre de la "Caja" y "Porcentaje".
       */
      async function renderizarDistribuciones(registros) {
        // Obtener el mapa de nombres de cajas
        const mapaCajas = await obtenerCajas();

        const grupos = {};
        registros.forEach((item) => {
          const distribucion = item.fields["Distribución"] || "Sin Distribución";
          // Omitimos si el valor de la distribución es "Distr. ø"
          if (distribucion === "Distr. ø") return;

          if (!grupos[distribucion]) {
            grupos[distribucion] = [];
          }
          grupos[distribucion].push(item);
        });

        const distributionBox = document.getElementById("distributionBox");
        distributionBox.innerHTML = "";

        Object.keys(grupos).forEach((grupo) => {
          const bloque = document.createElement("div");
          bloque.className = "distribution-client";
          bloque.innerHTML = `<h3>${grupo}</h3>`;

          const lista = document.createElement("ul");

          grupos[grupo].forEach((registro) => {
            const campos = registro.fields;
            const cajaId = campos["Caja"];
            const cajaNombre = mapaCajas[cajaId] || "(Sin caja)";
            let porcentaje = campos["Porcentaje"] !== undefined ? campos["Porcentaje"] : 0;
            // Muestra el nombre de la caja y el porcentaje
            const li = document.createElement("li");
            li.textContent = `${cajaNombre}: ${porcentaje}%`;
            lista.appendChild(li);
          });

          bloque.appendChild(lista);
          distributionBox.appendChild(bloque);
        });
      }

      /************************************************************
       *                 Creación de movimientos
       ************************************************************/

      /**
       * Crea un registro en la tabla "FDI-Movimientos" con los campos especificados.
       */
      async function crearMovimiento(campos) {
        try {
          const url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(
            TABLE_MOVIMIENTOS
          )}`;
          const respuesta = await fetch(url, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${AIRTABLE_API_KEY}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              records: [{ fields: campos }],
            }),
          });
          if (!respuesta.ok) {
            const errorData = await respuesta.json();
            throw new Error(
              `No se pudo crear el registro: ${
                errorData.error?.message || "Error desconocido"
              }`
            );
          }
          return await respuesta.json();
        } catch (error) {
          console.error("crearMovimiento:", error);
          throw error;
        }
      }

      /**
       * Manejador del botón "Agregar Movimiento".
       */
      document
        .getElementById("btnAgregarMovimiento")
        .addEventListener("click", async () => {
          const fecha = document.getElementById("fechaMovimiento").value;
          const inversor = document.getElementById("inversorMovimiento").value;
          const accion = document.getElementById("accionMovimiento").value;
          const cantidad =
            parseFloat(document.getElementById("cantidadMovimiento").value) || 0;

          if (!fecha || !accion) {
            alert("Por favor, complete al menos la fecha y la acción.");
            return;
          }

          try {
            await crearMovimiento({
              Fecha: fecha,
              Inversor: inversor,
              "Acción": accion,
              Cantidad: cantidad,
            });

            // Recargar datos principales
            await obtenerMovimientos();
            await obtenerCajaUndertango();
            await obtenerFondoInversion();
            await obtenerTotalAcciones();
            await obtenerInversores();
            await obtenerEvolucionActivos();

            calcularValores();
            renderizarDatos();
            dibujarGrafico();

            // Limpiar formulario
            document.getElementById("fechaMovimiento").value = "";
            document.getElementById("inversorMovimiento").value = "";
            document.getElementById("accionMovimiento").value = "";
            document.getElementById("cantidadMovimiento").value = "";

            alert("Movimiento agregado correctamente.");
          } catch (error) {
            console.error("Error al agregar movimiento:", error);
            alert("Ocurrió un error al agregar el movimiento.");
          }
        });

      /************************************************************
       *                 Funciones auxiliares
       ************************************************************/

      /**
       * Formatea un número como moneda en pesos argentinos.
       */
      function formatearDinero(numero) {
        return new Intl.NumberFormat("es-AR", {
          style: "currency",
          currency: "ARS",
          maximumFractionDigits: 2,
        }).format(numero || 0);
      }

      /************************************************************
       *             Inicialización al cargar la página
       ************************************************************/
      document.addEventListener("DOMContentLoaded", async () => {
        // 1) Obtener datos principales
        await obtenerCajaUndertango();
        await obtenerFondoInversion();
        await obtenerTotalAcciones();
        await obtenerInversores();
        await obtenerEvolucionActivos();
        await obtenerDistribuciones();
        await obtenerMovimientos();

        // 2) Calcular valores y renderizar
        calcularValores();
        renderizarDatos();
        dibujarGrafico();
      });
    </script>
  </body>
</html>